# Migration Sample

Demonstrates the EF Core migration workflow with ClickHouse using EF.CH.

## What it demonstrates

- Separating entity definitions and `DbContext` into their own file (`SampleDbContext.cs`)
- Configuring MergeTree engine with ORDER BY and monthly partitioning
- Running migrations programmatically via `MigrateAsync()`
- The CLI migration workflow (`dotnet ef migrations add`, `dotnet ef database update`)
- Inserting and querying data after schema creation

## Prerequisites

- [.NET 8 SDK](https://dotnet.microsoft.com/download/dotnet/8.0)
- [EF Core CLI tools](https://learn.microsoft.com/en-us/ef/core/cli/dotnet): `dotnet tool install --global dotnet-ef`
- A running ClickHouse instance (Docker is the easiest option)

## How to run

1. Start a ClickHouse server:

```bash
docker run -d --name clickhouse -p 8123:8123 clickhouse/clickhouse-server:latest
```

2. Run the sample (uses `EnsureCreatedAsync` for quick setup):

```bash
dotnet run
```

## Step-by-step migration workflow

For a real project, you would use EF Core migrations instead of `EnsureCreatedAsync`:

### 1. Create the initial migration

```bash
dotnet ef migrations add InitialCreate
```

This generates files in a `Migrations/` folder containing the SQL to create your tables with ClickHouse-specific DDL (MergeTree engine, ORDER BY, PARTITION BY, etc.).

### 2. Preview the generated SQL

```bash
dotnet ef migrations script
```

Review the output to see the exact ClickHouse DDL that will be executed.

### 3. Apply the migration

```bash
dotnet ef database update
```

Or apply programmatically in your application startup:

```csharp
await context.Database.MigrateAsync();
```

### 4. Evolve the schema

When you change your entity model (add a column, change a type, etc.):

```bash
dotnet ef migrations add AddStockQuantityColumn
dotnet ef database update
```

EF.CH generates the appropriate `ALTER TABLE` statements for ClickHouse.

## Expected output

```
=== EF.CH Migration Sample ===

[1] Applying migrations...
    Calling context.Database.MigrateAsync()
    This creates or updates the database schema based on migration files.

    Schema applied successfully.

[2] Inserting sample products...
    Inserted 5 products.

[3] Querying products by category...
    Electronics     Count=3  AvgPrice=64.32  TotalStock=730
    Furniture       Count=2  AvgPrice=269.50  TotalStock=100

[4] All products (ordered by price desc)...
    Standing Desk             Furniture       $449.00    Stock=25
    Mechanical Keyboard       Electronics     $149.99    Stock=80
    Monitor Arm               Furniture       $89.99     Stock=75
    Wireless Mouse            Electronics     $29.99     Stock=150
    USB-C Cable               Electronics     $12.99     Stock=500

=== Done ===
```

## Project structure

```
MigrationSample/
  MigrationSample.csproj    -- Project file with EF.CH and Design package references
  SampleDbContext.cs         -- DbContext and entity definitions (separate file)
  Program.cs                 -- Application entry point demonstrating the workflow
  Migrations/                -- Generated by 'dotnet ef migrations add' (not included)
```
